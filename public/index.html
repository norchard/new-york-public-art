<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <title>Hello</title>
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.js'></script>
        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.css' rel='stylesheet' />
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://use.typekit.net/hoi6yhq.js"></script>
        <script>try{Typekit.load({ async: true });}catch(e){}</script>
        <style>
            svg {position: relative;}
            body { margin: 0; padding: 0; font-family: "macho", sans-serif; }
            h1 { font-style: italic; font-size: 50px; color: #444444; line-height: 0.9; }
            h1, h2 { transition: background-color 0.5s; transition-timing-function: ease; padding: 20px 35px 20px 35px; }
            h2:hover { transition: background-color 0.5s; transition-timing-function: ease; background-color: rgba(0,0,0,0.1); }
            p { padding: 0 35px 25px 35px; font-size: 17px; line-height: 1.5; margin: 0; }
            span { color: #ffffff; }
            a { color: rgba(0,0,0,0.3); text-decoration: none;}
            a:hover { color: rgba(0,0,0,0.6); }
            button { background-color: rgba(0,0,0,0.0); border: 2px solid rgba(0,0,0,0.2);
                     padding: 5px 10px; margin: 10px 35px 35px 35px; color: rgba(0,0,0,0.2);
                     text-transform: uppercase; font-weight: 700; border-radius: 20px; font-family: "macho";
                     font-size: 12px;}
            button:hover { border-color: rgba(0,0,0,0.6); color: rgba(0,0,0,0.6); cursor: pointer;}
            path:hover { cursor:pointer; }
            #text { float:left; width: 50vw; }
            #container { width: 50vw; height: 100vh; right: 0; position: fixed; padding: 0; }
            #map { position:relative; width:100%; height: 100%; }
            .artwork h2 { margin: 0; color: #ffffff; font-weight: 400; }
            .artwork {  height: auto; }
            .artist { padding-left: 10px; display: inline; color: rgba(0,0,0,0.2); font-weight: 700; }
            .image-div { padding: 0px 35px 35px 35px; }
            .image { width: 100%; object-fit: fill; overflow: hidden; border-radius: 20px; }
            /*.hide { display: none; }*/
        </style>
    </head>

    <body>
      <div id="text">
        <h1>New York City </br> Temporary Public Artwork</h1>
      </div>
      <div id='container'>
        <div id='map'></div>
      </div>


      <script>

      d3.json("./data/artwork.json", function(err, data) {
          drawMap(data);
      });

      function drawMap(geojson){

          mapboxgl.accessToken = 'pk.eyJ1Ijoibm9yY2hhcmQiLCJhIjoiY2oyMHcxNXNhMDUwMTMzbnVkcmJ1eWszdSJ9.Dx5NmmL0h6xm3cUE5jLuJg'

          var map = new mapboxgl.Map({
              container: 'map', // container id
              style: 'mapbox://styles/mapbox/light-v9', //hosted style id
              center: [-73.9750, 40.7568], // starting position
              zoom: 12 // starting zoom
          });

          var container = map.getCanvasContainer();
          var svg = d3.select(container).append("svg")
                      .attr("width", "100%")
                      .attr("height", "100vh")
                      .attr("position", "absolute")

          var transform = d3.geoTransform({point: projectPoint});
          var path = d3.geoPath().projection(transform);

          var color = d3.scaleOrdinal(d3.schemeCategory20);

          var locations = svg.selectAll("path")
            .data(geojson)
            .enter()
            .append("path")
            .attr("d", path.pointRadius(function(d) {
                if (d3.select(this).attr('class') == 'select')
                  return 20;
                else
                  return 8;
             }))
            // .attr("d", d3.geoPath().projection(transform))
            .attr("fill", function(d) { return color(d.properties.number); })
            .attr("stroke-width", 2)
            .attr("stroke", "white")
            .attr('id', function(d) { return d.properties.number; })
            .on("click", function(d) { clickHandler(d) })
            // .on("click", function(d){
            //   d3.select(this).attr("fill-opacity", 0.2)
            //   d3.selectAll('div').filter(function(){
            //     return d3.select(this).attr('id') == d.properties.number
            //   }).append('p')
            //     .html(d.properties.description);
            //
            //   map.flyTo({center: d.geometry.coordinates});
            // })
            // .on("mouseout", function(d){
            //   d3.select(this).attr("fill-opacity", 1)
            //   d3.select("#text").select("p").remove();
            // })

          geojson.forEach(function (artwork, index) {
              d3.select('#text')
                .append('div')
                .attr('id', index)
                .attr('class', 'artwork')
                .style('background-color',function(d) { return color(artwork.properties.number); })
                .append('h2')
                .html(artwork.properties.name)
                .on("click", function() { clickHandler(artwork) })
                .append("p")
                .attr('class', 'artist')
                .html( artwork.properties.artist);
          });

          function clickHandler(d) {
            close();

            // console.log('open!');
            // console.log(d);

            document.getElementById(d.properties.number).scrollIntoView();

            map.flyTo({center: d.geometry.coordinates});

            // d3.select('text').select(this.childNodes)
            //   .attr('class', 'hide');

            var artDiv = d3.selectAll('div')
              .filter(function() { return d3.select(this).attr("id") == d.properties.number })
              // .attr('class', 'selected');

            var formatDate = d3.timeFormat("%B")

            var start = new Date(d.properties.from_date);
            var end = new Date(d.properties.to_date);

            artDiv.append('span')
              .html(d.properties.description)
              .append('button')
              .html('close')
              .on("click", function() { close(); });

            svg.selectAll("path")
              .filter(function(){return d3.select(this).attr("id") == d.properties.number; })
              .attr('class', 'select');


            // function httpGetAsync(theUrl, callback)
            // {
            //   var xhr = new XMLHttpRequest();
            //   xhr.open("GET", theUrl, true);
            //   xhr.onload = function (e) {
            //     if (xhr.readyState === 4 && xhr.status === 200) {
            //       if (xhr.status === 200) {
            //         console.log(xhr.responseText);
            //       } else {
            //         console.error(xhr.statusText);
            //       }
            //     }
            //   };
            //   xhr.onerror = function (e) {
            //     console.error(xhr.statusText);
            //   };
            //   xhr.send(null);
            // }

            // function toQueryString(paramsObject) {
            //   return Object
            //     .keys(paramsObject)
            //     .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(paramsObject[key])}`)
            //     .join('&')
            //   ;
            // }

            // var parameters = {
            //   cx: '008601265566446087848:kj2rcgrvxrk',
            //   imgType: 'photo',
            //   searchType: 'image',
            //   num: 1,
            //   q: d.properties.name + ' ' + d.properties.artist + ' New York'
            // };

            function httpGetAsync(theUrl, callback)
            {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", theUrl, true); // true for asynchronous
                xhr.setRequestHeader('Ocp-Apim-Subscription-Key', '03235899f7754611a972827f7ccfc286');
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200)
                        callback(xhr.responseText);
                };
                xhr.send(null);
            }

            var searchQuery = '\"' + d.properties.name + '\"+\"' + d.properties.artist + '\"' + '&count=1&mkt=en-us&imageType=Photo&size=large&aspect=wide';

            // var searchQuery = query.replace(/\s/g,'+');

            console.log(searchQuery);

            var searchURL = 'https://api.cognitive.microsoft.com/bing/v5.0/images/search?q=' + searchQuery;
            // var searchURL = 'https://www.googleapis.com/customsearch/v1?' + toQueryString(parameters);

            httpGetAsync(searchURL, function(response) {
                var data = JSON.parse(response);
                console.log(data.value[0].contentUrl);

                artDiv.select('span')
                  .append('div').attr('class','image-div')
                  .append('img').attr('src',data.value[0].contentUrl).attr('class','image');
            });

            key = 'AIzaSyAKz7rXL9SBUhwl15DTYoPq_u0mW2rVI1U'

            // svg.selectAll("path")
            //   .data(d)
            //   .enter()
            //   .append("path")
            //   .attr("d", d3.geoPath().projection(transform))
            //   .attr("fill", "black")
            //   .attr("stroke-width", 2)
            //   .attr("stroke", "white");
          }

          function close() {
            var hello = d3.selectAll("path")
              .classed("select", false);

            console.log(hello);

            d3.selectAll('span')
              .remove();

            console.log('closed!')
          }

          function update() {
              locations.attr("d", path);
          }

          map.on("viewreset", function() {
            update()
          })
          map.on("move", function() {
            update()
          })

        update()

        function projectPoint(lon, lat) {
              var point = map.project(new mapboxgl.LngLat(lon, lat));
          this.stream.point(point.x, point.y);
        }
      }
      </script>
    </body>
</html>
